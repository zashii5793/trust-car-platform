rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // ユーザーが認証済みかどうか
    function isAuthenticated() {
      return request.auth != null;
    }

    // 自分自身のデータかどうか
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }

    // ドキュメントの所有者かどうか（userId フィールドで判定）
    function isDocumentOwner() {
      return isAuthenticated() && resource.data.userId == request.auth.uid;
    }

    // 作成時に自分のユーザーIDを設定しているか
    function isCreatingOwnDocument() {
      return isAuthenticated() && request.resource.data.userId == request.auth.uid;
    }

    // ユーザードキュメント
    match /users/{userId} {
      // 自分のデータのみ読み書き可能
      allow read, write: if isOwner(userId);
    }

    // 車両データ
    match /vehicles/{vehicleId} {
      // 自分の車両のみ読み取り可能
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;

      // 作成時は自分のユーザーIDを設定していること
      allow create: if isCreatingOwnDocument();

      // 更新・削除は所有者のみ
      allow update, delete: if isDocumentOwner();
    }

    // メンテナンス記録
    match /maintenance_records/{recordId} {
      // 自分の記録のみ読み取り可能
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;

      // 作成時は自分のユーザーIDを設定していること
      allow create: if isCreatingOwnDocument();

      // 更新・削除は所有者のみ
      allow update, delete: if isDocumentOwner();
    }

    // 通知データ
    match /notifications/{notificationId} {
      // 自分の通知のみ読み取り可能
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;

      // 作成時は自分のユーザーIDを設定していること
      allow create: if isCreatingOwnDocument();

      // 更新・削除は所有者のみ
      allow update, delete: if isDocumentOwner();
    }

    // 請求書データ (Phase 5)
    match /invoices/{invoiceId} {
      // 自分の請求書のみ読み取り可能
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;

      // 作成時は自分のユーザーIDを設定していること
      allow create: if isCreatingOwnDocument();

      // 更新・削除は所有者のみ
      allow update, delete: if isDocumentOwner();
    }

    // 書類データ (Phase 5)
    match /documents/{documentId} {
      // 自分の書類のみ読み取り可能
      allow read: if isAuthenticated() && resource.data.userId == request.auth.uid;

      // 作成時は自分のユーザーIDを設定していること
      allow create: if isCreatingOwnDocument();

      // 更新・削除は所有者のみ
      allow update, delete: if isDocumentOwner();
    }

    // サービスメニューデータ (Phase 5)
    match /service_menus/{menuId} {
      // 有効なメニューは認証済みユーザーなら誰でも読み取り可能
      allow read: if isAuthenticated();

      // 作成・更新・削除は管理者のみ（BtoBフェーズで実装予定）
      // 現在は認証済みユーザーで自店舗のメニューのみ
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() &&
        (resource.data.shopId == '' || resource.data.shopId == request.auth.uid);
    }

    // 店舗データ (BtoB Marketplace)
    match /shops/{shopId} {
      // アクティブな店舗は認証済みユーザーなら誰でも閲覧可能
      allow read: if isAuthenticated();

      // 店舗の作成・更新・削除は店舗オーナーまたは管理者のみ
      // 現在はシード用に認証ユーザーに許可（本番では制限必要）
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated();
    }

    // パーツリスティングデータ (BtoB Marketplace)
    match /part_listings/{listingId} {
      // 有効なリスティングは認証済みユーザーなら誰でも閲覧可能
      allow read: if isAuthenticated();

      // リスティングの作成・更新・削除は店舗オーナーのみ
      allow create: if isAuthenticated();
      allow update, delete: if isAuthenticated() &&
        resource.data.shopId == request.auth.uid;
    }

    // 問い合わせデータ (BtoB Marketplace)
    match /inquiries/{inquiryId} {
      // 問い合わせは当事者（ユーザーまたは店舗）のみ閲覧可能
      allow read: if isAuthenticated() &&
        (resource.data.userId == request.auth.uid || resource.data.shopId == request.auth.uid);

      // 作成時は自分のユーザーIDを設定していること
      allow create: if isCreatingOwnDocument();

      // 更新は当事者のみ
      allow update: if isAuthenticated() &&
        (resource.data.userId == request.auth.uid || resource.data.shopId == request.auth.uid);

      // 削除は不可（履歴保持）
      allow delete: if false;

      // 問い合わせ内のメッセージ
      match /messages/{messageId} {
        // メッセージは問い合わせの当事者のみ閲覧可能
        allow read: if isAuthenticated();

        // メッセージ作成は当事者のみ
        allow create: if isAuthenticated();

        // 更新は既読フラグのみ
        allow update: if isAuthenticated();

        // 削除は不可
        allow delete: if false;
      }
    }

    // 車両マスターデータ (読み取り専用)
    match /vehicle_masters/{docType} {
      allow read: if isAuthenticated();
      allow write: if false;  // 管理者のみ（別途管理画面から更新）

      match /items/{itemId} {
        allow read: if isAuthenticated();
        allow write: if false;
      }
    }

    // ==================== SNS/コミュニティ機能 ====================

    // 投稿データ
    match /posts/{postId} {
      // 公開投稿は認証済みユーザーなら誰でも閲覧可能
      // フォロワー限定・非公開は別途フィルタリング
      allow read: if isAuthenticated();

      // 作成時は自分のユーザーIDを設定していること
      allow create: if isCreatingOwnDocument();

      // 更新・削除は所有者のみ
      allow update, delete: if isDocumentOwner();
    }

    // コメントデータ
    match /comments/{commentId} {
      // コメントは認証済みユーザーなら誰でも閲覧可能
      allow read: if isAuthenticated();

      // 作成時は自分のユーザーIDを設定していること
      allow create: if isCreatingOwnDocument();

      // 更新・削除は所有者のみ
      allow update, delete: if isDocumentOwner();
    }

    // 投稿へのいいね
    match /post_likes/{likeId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;
      allow update: if false;  // いいねの更新は不可
    }

    // コメントへのいいね
    match /comment_likes/{likeId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() &&
        request.resource.data.userId == request.auth.uid;
      allow delete: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;
      allow update: if false;
    }

    // フォロー関係
    match /follows/{followId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() &&
        request.resource.data.followerId == request.auth.uid;
      allow delete: if isAuthenticated() &&
        resource.data.followerId == request.auth.uid;
      allow update: if false;  // フォロー関係の更新は不可
    }

    // ユーザープロフィール（SNS用）
    match /user_profiles/{userId} {
      // プロフィールは認証済みユーザーなら誰でも閲覧可能
      allow read: if isAuthenticated();

      // 更新は自分自身のみ
      allow create, update: if isOwner(userId);
      allow delete: if false;  // プロフィール削除は不可
    }

    // SNS通知
    match /social_notifications/{notificationId} {
      // 自分の通知のみ閲覧可能
      allow read: if isAuthenticated() &&
        resource.data.userId == request.auth.uid;

      // 通知作成は認証済みユーザー（システム側で作成）
      allow create: if isAuthenticated();

      // 既読フラグの更新のみ許可
      allow update: if isAuthenticated() &&
        resource.data.userId == request.auth.uid &&
        request.resource.data.diff(resource.data).affectedKeys().hasOnly(['isRead']);

      allow delete: if false;
    }

    // その他のドキュメントはデフォルトで拒否
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
