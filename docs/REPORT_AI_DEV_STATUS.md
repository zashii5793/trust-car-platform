# Trust Car Platform - AI開発 現状レポート

## 1. プロジェクト概要

| 項目 | 内容 |
|------|------|
| プロダクト | 車両管理・メンテナンス記録アプリ |
| 技術スタック | Flutter / Firebase (Auth, Firestore, Storage) |
| AI開発ツール | Claude Code (Claude Opus 4.5) |
| 開発期間 | Phase 0〜3完了 |
| コード規模 | Dart 約6,000行（lib/）、テスト約2,500行 |

---

## 2. AI活用方法

### 2.1 協業レベルの運用

参考: [BM-SMS Tech Blog - Claude Code活用のワークフロー設計](https://tech.bm-sms.co.jp/entry/2026/02/04/110000)

| レベル | 対象タスク | 実績 |
|--------|-----------|------|
| **Delegate** | テスト追加、バグ修正 | AuthServiceテスト23件など |
| **Inquire** | 新機能実装 | 統計画面、OCR機能など |
| **Agree** | アーキテクチャ変更 | Result<T,AppError>パターン導入 |
| **Consult** | 要件定義・優先順位 | BtoBマーケット機能の設計相談 |

### 2.2 AI開発で確立した仕組み

- **CLAUDE.md**: 最小限のプロジェクトコンテキスト（Progressive Disclosure原則）
- **セッションメモ**: セッション間の状態引き継ぎ
- **効率化ルール**: トークン節約のためのファイル読み込み制限
- **TodoWrite**: タスク管理の可視化

### 2.3 AI開発の成果

- エラーハンドリングの統一（Result型パターン）をセッション内で一貫して適用
- テスト駆動的な品質管理（各変更後に`flutter test`+`flutter analyze`実行）
- 段階的な品質改善（P0→P1→P2→Phase 3）

### 2.4 AI開発の課題（率直に）

| 課題 | 詳細 | 対策 |
|------|------|------|
| **コンテキスト喪失** | セッション切れで設計方針が断絶し、二重管理構造が発生 | CLAUDE.mdにアーキテクチャ方針を明記 |
| **品質スコアの過大評価** | テスト数だけで9.5/10としていたが、Provider/UI層のテスト欠落を見落とし | カバレッジマトリクスで層別管理に変更 |
| **楽観バイアス** | AIが「問題なし」と報告しがちで、構造的課題の発見が遅れた | 定期的な批判的レビューを組み込む |

---

## 3. 現在の品質評価（修正後）

### 3.1 品質スコア: 7.5/10（Phase 3.5完了後）

| 領域 | スコア | 根拠 |
|------|--------|------|
| コア層の品質 | 9/10 | Result型、AppError、モデル層は堅実 |
| アーキテクチャ一貫性 | 8/10 | Phase 3.5でdomain/data削除、services/に統一、全ProviderにDI適用 |
| テストカバレッジ | 6/10 | 214件あるがProvider/UI層が欠落 |
| 運用準備度 | 4/10 | CI/CD、インデックス、環境分離なし |

### 3.2 テストカバレッジの実態

| 層 | ファイル数 | テスト | 状態 |
|----|-----------|--------|------|
| core/ (Result, AppError等) | 4 | 67件 | 充実 |
| models/ | 4 | 48件 | 充実 |
| services/ (OCR) | 2 | 46件 | 充実 |
| services/ (Firebase) | 1 | 27件 | 部分的 |
| services/ (Auth) | 1 | 23件 | 新規追加 |
| **providers/ (4個)** | **4** | **0件** | **欠落** |
| **screens/ (14個)** | **14** | **1件** | **ほぼ欠落** |
| **services/ (PDF, 推奨)** | **2** | **0件** | **欠落** |

### 3.3 アーキテクチャの現状（Phase 3.5完了後）

```
現在の構成（Phase 3.5で統一済み）:
  main.dart → Injection.init() → ServiceLocator
                                      ↓
  Provider（コンストラクタ注入）← Service（Result<T,AppError>）
      ↓                                ↓
    UI層（screens/）              Firebase SDK

残課題:
  - Screen層で一部Serviceを直接new（OCR, PDF）→ DI経由に移行推奨
  - NotificationProviderでFirestore直接アクセス → 修正推奨
```

---

## 4. 実装済み機能一覧

### コア機能
- 車両管理（CRUD、ナンバープレート重複チェック、走行距離整合性チェック）
- 整備記録管理（22タイプ、CRUD）
- 車検証OCRスキャン（ML Kit Text Recognition）
- 請求書OCRスキャン
- 認証（メール/パスワード、Google）
- PDF出力
- メンテナンス推奨通知

### 品質改善
- P0: 車検・保険アラート、バリデーション強化
- P1: エラーハンドリング統一（Result<T,AppError>）
- P2: 必須項目明示、エラーメッセージ改善
- Phase 3: データ同期安定化、AuthService統一、統計画面

---

## 5. 今後の計画

### 5.1 技術的負債の解消（Phase 3.5で一部完了）

| 項目 | 内容 | 状態 |
|------|------|--------|
| アーキテクチャ統一 | domain/data層削除、services/に統一 | ✅ 完了 |
| Provider DI適用 | 全ProviderにServiceLocator経由の注入 | ✅ 完了 |
| Screen層DI適用 | OCR/PDFサービスをDI経由に移行 | 🔄 未着手 |
| Provider テスト | 5つのProviderのユニットテスト追加 | 🔄 未着手 |
| CI/CD | GitHub Actions でテスト・解析の自動実行 | 🔄 未着手 |
| Firestoreインデックス | 複合クエリ用のインデックス定義 | 🔄 未着手 |

### 5.2 機能ロードマップ

| Phase | 内容 | 状態 |
|-------|------|------|
| **Phase 3.5** | アーキテクチャ統一、Provider DI | ✅ 完了 |
| **Phase 3.6** | Screen層DI、Providerテスト | 🔄 進行中 |
| **Phase 4** | オフラインサポート、プッシュ通知 | - |
| **Phase 5** | BtoBカスタムパーツマーケットプレイス | - |

### 5.3 AI開発手法の改善計画

| 改善 | 内容 | 状態 |
|------|------|------|
| **CLAUDE.mdにアーキテクチャ方針明記** | 二重管理の再発防止 | ✅ 完了 |
| **批判的レビューの定期実施** | 各Phase完了時にエキスパート監査 |
| **カバレッジマトリクス** | 層別のテスト状況を可視化 |
| **コミット前チェックリスト** | DI使用、テスト有無、解析クリーンを確認 |

---

## 6. まとめ

### 成果
- AI開発により、単独開発者で6,000行超のFlutterアプリを段階的に構築
- コア層（エラーハンドリング、モデル）の品質は高い
- OCR機能など技術的に複雑な機能もテスト付きで実装

### 課題
- セッション間のコンテキスト断絶によるアーキテクチャの不整合
- テストカバレッジの偏り（コア層は強いがビジネスロジック層が弱い）
- 楽観的な品質評価（AI自身による自己評価のバイアス）

### 教訓
- **「AIはコンテキストがすべて」**: 設計方針をCLAUDE.mdに明示しないと、セッションごとに異なる判断をする
- **AIの自己評価を鵜呑みにしない**: 定期的な批判的レビュー（今回のような総点検）が必要
- **Progressive Disclosure**: CLAUDE.mdは最小限に、詳細は別ドキュメントに分離する運用が有効
